<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
    <script src="menu.js"></script>
    <script src="contasService.js"></script>
    <script src="tiposMovimentosService.js"></script>
</head>

<body>
    <script>

    window.onload = onInit
    
    ordenacao = false;
    contas = [];
    tiposMovimentos = [];
    filtroConta = null;

    function onInit() {

        const urlParams = new URLSearchParams(window.location.search);
        filtroConta = urlParams.get('conta');
        console.log(filtroConta);

        let htmlMenu = menu();
        let element = document.getElementById('nav');
        element.innerHTML = htmlMenu;

        let promiseContas = buscarContas();
        let promiseTiposMovimentos = buscarTiposMovimentos();

        Promise.all([promiseContas,promiseTiposMovimentos]).then(([contasResponse,tiposmovimentosResponse]) => {
            contas = contasResponse
            tiposMovimentos = tiposmovimentosResponse
            montaNomeContaTitulo();
            montaSelectOptionsContas();
            montaSelectOptionsTiposMovimentos();
            atualizaListaMovimentos();
        })
    }

    async function montaNomeContaTitulo() {
        if(filtroConta != null && filtroConta != '') {
            let conta = contas.filter((conta) => {
                return conta.id == filtroConta
            });
            let tituloContaFiltrada = document.getElementById('tituloContaFiltrada')
            tituloContaFiltrada.innerHTML = ' - ' + conta[0].nome;
        }
    }

    async function montaSelectOptionsContas () {
        let contaMovimento = document.getElementById('contaMovimento');
        optionsContas = "<option value='' selected>-</option>";
        contas.forEach(conta => {
            optionsContas += `<option value='${conta.id}'>${conta.nome}</option>`;
        });
        contaMovimento.innerHTML = optionsContas;
    }

    async function montaSelectOptionsTiposMovimentos () {
        let tipoMovimentoSelect = document.getElementById('tipoMovimento');
        optionsTiposMovimentos = "<option value='' selected>-</option>";
        tiposMovimentos.forEach(tipoMovimento => {
            optionsTiposMovimentos += `<option value='${tipoMovimento.id}'>${tipoMovimento.nome}</option>`;
        });
        tipoMovimentoSelect.innerHTML = optionsTiposMovimentos;
    }

    function atualizaListaMovimentos () {
        buscarMovimentos().then(movimentos => {
            console.log('dados', movimentos)
            montarListaMovimentos(movimentos);
        });
    }

    function toggleOrdenacao () {
        ordenacao = !ordenacao;
        atualizaListaMovimentos();
    }

    async function buscarMovimentos() {
        let url = 'http://localhost:8000/movimentos?';

        let params = {};

        if(filtroConta != null) {
            params['conta'] = filtroConta;
        }

        if(ordenacao == true){
            params['orderDateDesc'] = 1;
        }

        url += new URLSearchParams(params);

        console.log('url',url);

        const config = {
            method: 'GET'
        }

        return await fetch(url, config)
        .then(async(response) => {
            let text = await response.text()
            let dados = JSON.parse(text);
            return dados
        })
        .catch((error) => {
            console.error(error);
        });
    }

    async function criarMovimento(event) {
        event.preventDefault()
        let descricao = document.getElementById('descricaoMovimento').value
        let valor = document.getElementById('valorMovimento').value
        let dataMovimento = document.getElementById('dataMovimento').value
        let tipoMovimento = document.getElementById('tipoMovimento').value
        let contaMovimento = document.getElementById('contaMovimento').value

        body = {
            'descricao': descricao,
            'valor': valor,
            'dataMovimento': dataMovimento,
            'tipoMovimento': tipoMovimento,
            'contaMovimento': contaMovimento
        };
        const url = 'http://localhost:8000/movimentos';
        const config = {
            method: 'POST',
            body: JSON.stringify(body)
        }
        return await fetch(url, config)
        .then(async(response) => {
            let text = await response.text()
            let dados = JSON.parse(text);
            if(!response.ok) throw dados.message;
            atualizaListaMovimentos();
            return dados;
        })
        .catch((error) => {
            alert(error);
            console.error('error',error);
        });
    }

    function montarListaMovimentos(movimentos) {

        movimentos.forEach(movimento => {
            movimento.datamovimentoOriginal = movimento.datamovimento
            movimento.datamovimento = new Intl.DateTimeFormat('pt-BR').format(new Date(movimento.datamovimento));
        });

        let divListaMovimentos = document.getElementById('listaMovimentos');

        let html = '<table class="table">';
        html += '<th>Conta</th>';
        html += '<th>TipoMovimento</th>';
        html += '<th>Descricao</th>';
        html += '<th>Valor</th>';
        html += '<th><button type="button" onclick="toggleOrdenacao()">Data Movimento</button></th>';

        movimentos.forEach(movimento => {

            let contaMovimento;
            let tipoMovimentoMovimento;
            
            for (let i = 0; i < contas.length; i++) {
                const conta = contas[i];
                if(conta.id == movimento.conta) {
                    contaMovimento = conta;
                    break;
                }
            }
            
            for (let i = 0; i < tiposMovimentos.length; i++) {
                const tipoMovimento = tiposMovimentos[i];
                if(tipoMovimento.id == movimento.tipomovimento) {
                    tipoMovimentoMovimento = tipoMovimento;
                    break;
                }
            }

            html += `<tr>`
            html += `<td>${contaMovimento.nome}</td>`
            html += `<td>${tipoMovimentoMovimento.nome}</td>`
            html += `<td>${movimento.descricao}</td>`
            html += `<td>${movimento.valor}</td>`
            html += `<td>${movimento.datamovimento}</td>`
            html += `</tr>`
        });

        divListaMovimentos.innerHTML = html + '</table>'
    }

    </script>

    <nav id="nav"></nav>
    
    <h1>Criar Movimento</h1>


    <form action="#" onsubmit="criarMovimento(event)">
        Descrição: <input type="text" name="descricaoMovimento" id="descricaoMovimento">
        Valor: <input type="text" name="valorMovimento" id="valorMovimento">
        Data: <input type="date" name="dataMovimento" id="dataMovimento">
        Tipo: <select name="tipoMovimento" id="tipoMovimento"></select>
        Conta: <select name="contaMovimento" id="contaMovimento"></select>
        <input type="submit" value="Criar">
    </form>

    <hr>

    <h1>Lista de Movimentos <span id="tituloContaFiltrada"></span></h1>


    <div id="listaMovimentos"></div>
</body>

</html>